name: Checkout

on:
  workflow_dispatch:
  push:
    branches: ["master"]
  pull_request:
    branches:
      - "master"
      - "develop"
      - "feature/**"
      - "bugfix/**"
      - "hotfix/**"
      - "support/**"
    paths:
      - "pubspec.yaml"
      - "pubspec.lock"
      - ".github/**.yaml"
      - ".github/**.yml"
      - "lib/**.dart"
      - "test/**.dart"
      - "packages/**"
      - "web/**"
      - "android/**"
      - "ios/**"
      - "windows/**"
      - "linux/**"
      - "macos/**"

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  checkout:
    name: "ğŸ§ª Check code with analysis, format, and tests"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: ./
    steps:
      - name: ğŸ“¦ Get the .github actions
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github

      - name: ğŸš‚ Setup Flutter and dependencies
        uses: ./.github/actions/setup

      - name: ğŸ›  ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²ĞµÑ€ÑĞ¸Ğ¸ Flutter
        run: flutter --version

      - name: ğŸš¦ Check code format
        id: check-format
        timeout-minutes: 1
        run: |
          find lib test -name "*.dart" ! -name "*.*.dart" -print0 |
            xargs -0 dart format --set-exit-if-changed --line-length 120 -o none

      - name: ğŸ“ˆ Check for Warnings
        id: check-analyzer
        timeout-minutes: 1
        run: flutter analyze --fatal-infos --fatal-warnings lib/ test/

      - name: ğŸ§ª Unit & Widget tests
        timeout-minutes: 20
        run: flutter test --coverage --concurrency=43

      - name: ğŸ“¥ Upload test report
        uses: actions/upload-artifact@v4
        if: (success() || failure()) && ${{ github.actor != 'dependabot[bot]' }}
        with:
          name: test-results
          path: reports/tests.json
